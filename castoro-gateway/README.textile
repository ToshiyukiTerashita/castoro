h1. castoro-gateway

h2. Install

<pre>
gem install castoro-gateway-X.X.X.gem
</pre>

h2. Command (related to gateway)

It is a subcommand of castoro-gateway as follows.

h3. castoro-gateway setup

Create necessary configuration file by command for the gateway.
See below Usage.

<pre>
$ castoro-gateway setup --help
Usage: castoro-gateway setup [options]
    -v, --verbose                    verbose
    -f, --force                      Override config file
    -c, --conf <configfile>          Config file
    -t, --type <gateway type>        Gateway type, [original(default) master island]
</pre>

h3. castoro-gateway start

Command for starting up the castoro-gateway program.
See below Usage.

<pre>
$ castoro-gateway start --help
Usage: castoro-gateway start [options]
    -v, --verbose                    verbose
    -d, --daemon                     daemon mode
    -p, --pid <pidfile>              PID file (only for the daemon mode)
    -l, --log <logfile>              Log file (only for the daemon mode)
    -c, --conf <configfile>          Config file
    -e, --env <environment>          Execution environment
</pre>

h3. castoro-gateway stop

Command for stopping the castoro-gateway daemon program.
See below Usage.

<pre>
$ castoro-gateway stop --help
Usage: castoro-gateway stop [options]
    -v, --verbose                    verbose
    -f, --force                      force shutdown
    -p, --pid <pidfile>              PID file
</pre>

h3. castoro-gateway status

Command for displays the status of running gateway program.
See below Usage.

<pre>
$ castoro-gateway status
CACHE_EXPIRE            : 15
CACHE_REQUESTS          : 0
CACHE_HITS              : 0
CACHE_COUNT_CLEAR       : 0
CACHE_ALLOCATE_PAGES    : 15
CACHE_FREE_PAGES        : 15
CACHE_ACTIVE_PAGES      : 0
CACHE_HAVE_STATUS_PEERS : 0
CACHE_ACTIVE_PEERS      : 0
CACHE_READABLE_PEERS    : 0
</pre>

h3. castoro-gateway dump

Command for displays the cache dumped records.
See below Usage.

<pre>
$ castoro-gateway dump
  peer0: /expdsk/1/baskets/a/1.1.3
  peer1: /expdsk/1/baskets/a/1.1.3
  peer2: /expdsk/1/baskets/a/1.1.3
   ...
   ...
  peer1: /expdsk/1/baskets/a/9.1.1
  peer2: /expdsk/2/baskets/a/9.1.1
</pre>

h2. init.d script sample.

/etc/init.d/castoro-gatewayd

<pre>
#!/bin/sh
# castoro-gateway start/stop script.
# chkconfig: - 85 15
# description: castoro-gateway start/stop script.
. /etc/rc.d/init.d/functions

prog=castoro-gatewayd

base=/usr/local/bin/castoro-gateway
cnf=/etc/castoro/gateway.conf
pid=/var/castoro/gateway.pid
log=/var/castoro/gateway.log
env=default

start() {
  echo $"Start Castoro-Gateway ..."
  $base start -c $cnf -p $pid -l $log -e $env -d
}

stop() {
  echo $"Stop Castoro-Gateway ..."
  $base stop -p $pid
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    start
    ;;
  status)
    status -p $pid $prog
    ;;
  *)
    echo $"Usage: $prog {start|stop|restart|status}"
esac
</pre>

h2. gateway config file details.

Config file is based on the YAML format.

h3. example

<pre>
<% require 'logger' %>
--- 
default: 
  require: []
  logger: " Proc.new { |logfile| Logger.new(logfile) } "
  user: castoro
  group: 
  workers: 5
  loglevel: <%= Logger::INFO %>
  type: original
  gateway_console_port: 30110
  gateway_unicast_port: 30111
  gateway_multicast_port: 30109
  gateway_watchdog_port: 30113
  gateway_watchdog_logging: false
  peer_multicast_addr: 239.192.1.1
  peer_multicast_device: eth0
  peer_multicast_port: 30112
  cache: 
    watchdog_limit: 15
    return_peer_number: 5
    cache_size: 500000
    options: {}
</pre>

h3. configuration key details.

h4. logger

String that can be evaluated by eval,
Proc object that returns Logger.

h4. user

Effective user for gateway program.

h4. workers

count of worker processes.

h4. loglevel

logger level. must set to be between 0 and 5.
It conforms to the enumeration value of Logger::Severity.

h4. type

"original", "master", "island" either.

h4. gateway_console_port

TCP Port number for console.
for original and island.

h4. gateway_unicast_port

UDP Port number for unicast. (Client to Gateway)
for original and master.

h4. gateway_multicast_port

UDP Port number for multicast. (Peer to Gateway, Island to Master)
for original and master and island.

h4. gateway_watchdog_port

UDP Port number for watchdog. (Peer to Gateway)
for original and island.

h4. gateway_watchdog_logging

When true, watchdog packet logging.
for original and island.

h4. peer_multicast_addr

Address for multicast. (Gateway to Peer, and Peer to Gateway)
for original and island.

h4. peer_multicast_device

Network interface name for peer_multicast_addr
for original and island.

h4. peer_multicast_port

UDP Port number for multicast. (Gateway to Peer)
for original and island.

h4. master_multicast_addr

Multicast address for master-gateway.
for master and island.

h4. island_broadcast_port

Port number for island broadcast.
for master and island.

h4. island_multicast_addr

Multicast address for island.
for island.

h4. island_multicast_device

Network interface name for island_multicast_addr
for master and island.

h4. cache => watchdog_limit

Timeout second for watchdog.

h4. cache => return_peer_number

Count of peer hostname per return.

h4. cache => cache_size

Cache size (Bytes)

h3. configurations key list

|key|value-type|original|master|island|default|
|require|Array[String]|required|required|required|[]|
|logger|String|required|required|required|<code>" Proc.new { |logfile| Logger.new(logfile) } "</code>|
|user|String/Integer|required|required|required|castoro|
|group|String/Integer|||||
|workers|Integer|required|required|required|5|
|loglevel|Integer|required|required|required|1 (Logger::INFO)|
|type|String|required|required|required|original|
|gateway_console_port|Integer|required||required|30110|
|gateway_unicast_port|Integer|required|required||30111|
|gateway_multicast_port|Integer|required|required|required|30109|
|gateway_watchdog_port|Integer|required||required|30113|
|gateway_watchdog_logging|Boolean|required||required|false|
|peer_multicast_addr|String|required||required|239.192.1.1|
|peer_multicast_device|String|required||required|eth0|
|peer_multicast_port|Integer|required||required|30112|
|master_multicast_addr|String||required|required|239.192.254.254|
|island_broadcast_port|Integer||required|required|30108|
|island_multicast_addr|String|||required||
|island_multicast_device|String||required|required|eth0|

